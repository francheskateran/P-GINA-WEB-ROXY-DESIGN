<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mi Carrito - RoxyDesign</title>
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --primary: {{ site_config.color_principal }}; }
        body { font-family: 'Poppins', sans-serif; background: #f9f9f9; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        h2 { border-bottom: 2px solid var(--primary); padding-bottom: 10px; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { background: var(--primary); color: white; padding: 15px; text-align: left; }
        td { padding: 15px; border-bottom: 1px solid #eee; vertical-align: middle; }
        img { width: 60px; height: 60px; object-fit: cover; border-radius: 5px; }

        .total-box {
            margin-top: 30px;
            background: #f0f2f5;
            padding: 20px;
            border-radius: 10px;
            text-align: right;
        }
        .total-usd { font-size: 1.5rem; font-weight: bold; color: var(--primary); }
        .total-ves { font-size: 1.1rem; color: #555; margin-top: 5px; }

        .btn-pay {
            display: inline-block; background: var(--primary); color: white;
            padding: 15px 40px; text-decoration: none; font-weight: bold;
            border-radius: 30px; margin-top: 15px; cursor: pointer; border: none; font-size: 16px;
        }
        .btn-pay:disabled { background: #ccc; cursor: not-allowed; }

        .btn-action {
            background: #ddd; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold;
        }
        .btn-trash { background: #e74c3c; color: white; }
        .stock-info { font-size: 11px; color: #888; display: block; }

        .section-orders { margin-top: 40px; border-top: 2px dashed #ccc; padding-top: 20px; }
        .order-card { background: #e8f8f5; border: 1px solid var(--primary); padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;}

        /* MODAL DE PAGO */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 2000;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 500px;
            position: relative; max-height: 90vh; overflow-y: auto;
        }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px; }
        .form-group input, .form-group select {
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box;
        }
        .cedula-group { display: flex; gap: 10px; }

        /* NUEVOS ESTILOS AGREGADOS */
        .pago-datos-destinatario {
            background: #fff9e6; border: 1px solid #ffeeba; padding: 15px; border-radius: 10px; margin-bottom: 20px; font-size: 14px;
        }
        .pago-datos-destinatario p { margin: 5px 0; }
        #preview-pago {
            width: 100%; max-height: 200px; object-fit: contain; margin-top: 10px; display: none; border-radius: 8px; border: 1px solid #ddd;
        }
    </style>
</head>
<body>

<div class="container">

    {% if ordenes_pago %}
    <div class="section-orders">
        <h3 style="color: var(--primary);">¡Pedidos Aprobados! Proceder al Pago</h3>
        {% for orden in ordenes_pago %}
            <div class="order-card">
                <div>
                    <strong>Pedido #{{ orden.idO }}</strong> - Esperando Pago<br>
                    <small>Total a Pagar: <b>$ {{ orden.total }}</b></small>
                </div>
                <button onclick="abrirModalPago('{{ orden.idO }}', '{{ orden.total }}', '{{ (orden.total * site_config.tasa_bcv) | round(2) }}')" class="btn-pay" style="margin:0; font-size: 14px;">Reportar Pago</button>
            </div>
        {% endfor %}
    </div>
    {% endif %}

    <h2>Mi Carrito de Compras</h2>

    {% if items %}
    <table>
        <thead>
            <tr>
                <th>Producto</th>
                <th>Precio</th>
                <th>Cant.</th>
                <th>Subtotal</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% set vars = {'total': 0} %}
            {% for item in items %}
            <tr>
                <td>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <img src="{{ url_for('static', filename='img/' + (item.imagen_url if item.imagen_url else 'default.png')) }}">
                        <div>
                            {{ item.NombreP }}
                            <span class="stock-info">Disp: {{ item.stock }}</span>
                        </div>
                    </div>
                </td>
                <td>$ {{ item.Precio }}</td>
                <td>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <form action="{{ url_for('actualizar_carrito') }}" method="POST" style="display:inline;">
                            <input type="hidden" name="id_cp" value="{{ item.idCP }}">
                            <input type="hidden" name="accion" value="restar">
                            <button type="submit" class="btn-action">-</button>
                        </form>
                        <span style="font-weight: bold; width: 20px; text-align: center;">{{ item.cantidad }}</span>
                        <form action="{{ url_for('actualizar_carrito') }}" method="POST" style="display:inline;">
                            <input type="hidden" name="id_cp" value="{{ item.idCP }}">
                            <input type="hidden" name="accion" value="sumar">
                            <button type="submit" class="btn-action">+</button>
                        </form>
                    </div>
                </td>
                <td>$ {{ "{:.2f}".format(item.Precio * item.cantidad) }}</td>
                <td>
                    <form action="{{ url_for('actualizar_carrito') }}" method="POST">
                        <input type="hidden" name="id_cp" value="{{ item.idCP }}">
                        <input type="hidden" name="accion" value="eliminar">
                        <button type="submit" class="btn-action btn-trash"><ion-icon name="trash-outline"></ion-icon></button>
                    </form>
                </td>
                {% if vars.update({'total': vars.total + (item.Precio * item.cantidad)}) %}{% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="total-box">
        <div class="total-usd">Total Estimado: $ {{ "{:.2f}".format(vars.total) }}</div>
        {% set total_bs = vars.total * site_config.tasa_bcv %}
        <div class="total-ves">En Bolívares: Bs. {{ "{:,.2f}".format(total_bs) }}</div>

        <form action="{{ url_for('procesar_pedido') }}" method="POST" id="form-pedido">
            <button type="button" class="btn-pay" onclick="confirmarSolicitud()">Solicitar Pedido</button>
        </form>
        <p style="font-size: 12px; color: #666; margin-top: 10px;">* Su pedido será revisado por el administrador.</p>
    </div>

    {% else %}
        <p style="text-align: center; padding: 40px; color: #888;">No tienes items pendientes en el carrito.</p>
    {% endif %}

    <div style="text-align: center; margin-top: 20px;">
        <a href="{{ url_for('inicio') }}" style="color: var(--primary); text-decoration: none;">← Volver a la tienda</a>
    </div>
</div>

<div id="modalPago" class="modal">
    <div class="modal-content">
        <h2 style="color: var(--primary);">Reportar Pago</h2>

        <div class="pago-datos-destinatario">
            <p><strong>Datos para Pago Móvil:</strong></p>
            <p>Banco: {{ site_config.pago_movil_banco if site_config.pago_movil_banco else 'Banco Venezolano de Credito' }}</p>
            <p>Teléfono: {{ site_config.pago_movil_telefono if site_config.pago_movil_telefono else '04143295642' }}</p>
            <p>Cédula: {{ site_config.pago_movil_cedula if site_config.pago_movil_cedula else 'V-6276322' }}</p>
            <p id="monto-a-pagar-modal" style="color: var(--primary); font-weight: bold; margin-top: 10px;"></p>
        </div>

        <p style="font-size: 14px; color: #666;">Complete los datos y adjunte el comprobante (o péguelo aquí).</p>

        <form action="{{ url_for('reportar_pago') }}" method="POST" enctype="multipart/form-data" id="formPago">
            <input type="hidden" name="orden_id" id="pagoOrdenId">

            <div class="form-group">
                <label>Comprobante (Capture) *</label>
                <input type="file" name="imagen_pago" id="inp-img" accept="image/*" required onchange="previewImage(event)">
                <img id="preview-pago" alt="Vista previa">
            </div>

            <div class="form-group">
                <label>Monto Pagado (Bs.) *</label>
                <input type="number" step="0.01" name="monto_pagado" id="inp-monto" placeholder="Ej: 500.00" required>
            </div>

            <div class="form-group">
                <label>Cédula del Titular *</label>
                <div class="cedula-group">
                    <select name="tipo_doc" style="width: 70px;">
                        <option value="V">V</option>
                        <option value="E">E</option>
                        <option value="P">P</option>
                        <option value="J">J</option>
                        <option value="G">G</option>
                    </select>
                    <input type="text" name="num_doc" id="inp-doc" placeholder="Solo números (ej: 12345678)" required>
                </div>
            </div>

            <div class="form-group">
                <label>Banco Emisor *</label>
                <select name="banco" id="inp-banco" required>
                    <option value="" disabled selected>Seleccione el Banco</option>
                    <option value="Banco Venezolano de Credito">Banco Venezolano de Crédito</option>
                    <option value="100% Banco">100% Banco Banco Universal</option>
                    <option value="Bancamiga">Bancamiga Banco Universal</option>
                    <option value="Banco Activo">Banco Activo Banco Comercial</option>
                    <option value="Banco Caroni">Banco Caroní Banco Universal</option>
                    <option value="Banfanb">Banco de la Fuerza Armada Nacional</option>
                    <option value="Bangente">Banco de la Gente Emprendedora</option>
                    <option value="Banco de Venezuela">Banco de Venezuela</option>
                    <option value="Bancaribe">Banco del Caribe Banco Universal</option>
                    <option value="Banco del Tesoro">Banco del Tesoro Banco Universal</option>
                    <option value="Banco Digital Trabajadores">Banco Digital de los Trabajadores</option>
                    <option value="Banco Exterior">Banco Exterior Banco Universal</option>
                    <option value="Banco Mercantil">Banco Mercantil</option>
                    <option value="BNC">Banco Nacional de Crédito</option>
                    <option value="Banco Plaza">Banco Plaza</option>
                    <option value="Banco Provincial">Banco Provincial Banco Universal</option>
                    <option value="Banco Sofitasa">Banco Sofitasa Banco Universal</option>
                    <option value="Bancrecer">Bancrecer Banco Microfinanciero</option>
                    <option value="Banesco">Banesco Banco Universal</option>
                    <option value="Banplus">Banplus Banco Universal</option>
                    <option value="BFC">BFC Banco Fondo Común</option>
                    <option value="Del Sur">Del Sur Banco Universal</option>
                    <option value="IMCP">Instituto Municipal de CDTO Popular</option>
                    <option value="N58">N58 Banco Digital Banco Microfinanciero</option>
                    <option value="R4">R4 Banco Microfinanciero</option>
                </select>
            </div>

            <div class="form-group">
                <label>Teléfono Emisor *</label>
                <input type="text" name="telefono" id="inp-tel" placeholder="04141234567" required>
            </div>

            <div class="form-group">
                <label>Referencia (Últimos 6 dígitos) *</label>
                <input type="text" name="referencia" id="inp-ref" placeholder="Ej: 123456" minlength="6" required>
            </div>

            <button type="submit" class="btn-pay" id="btn-enviar-pago" style="width: 100%; border:none;">Enviar Pago</button>
            <button type="button" onclick="document.getElementById('modalPago').style.display='none'"
                    style="width: 100%; margin-top: 10px; background: #ddd; border: none; padding: 10px; border-radius: 20px; cursor: pointer;">Cancelar</button>
        </form>
    </div>
</div>

<script>
    function confirmarSolicitud() {
        Swal.fire({
            title: '¿Confirmar Solicitud?',
            text: "Se enviará tu pedido al administrador para verificar disponibilidad.",
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '{{ site_config.color_principal }}',
            confirmButtonText: 'Sí, enviar solicitud'
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById('form-pedido').submit();
            }
        })
    }

    function abrirModalPago(idOrden, montoUsd, montoBs) {
        document.getElementById('pagoOrdenId').value = idOrden;
        document.getElementById('monto-a-pagar-modal').innerText = "Monto a Transferir: Bs. " + montoBs;
        document.getElementById('modalPago').style.display = 'flex';
    }

    // --- VISTA PREVIA DE IMAGEN ---
    function previewImage(event) {
        const reader = new FileReader();
        reader.onload = function(){
            const output = document.getElementById('preview-pago');
            output.src = reader.result;
            output.style.display = 'block';
        };
        reader.readAsDataURL(event.target.files[0]);
    }

    // --- PEGAR IMAGEN DESDE PORTAPAPELES ---
    document.addEventListener('paste', function(event) {
        if(document.getElementById('modalPago').style.display === 'flex'){
            const items = (event.clipboardData || event.originalEvent.clipboardData).items;
            for (let index in items) {
                const item = items[index];
                if (item.kind === 'file') {
                    const blob = item.getAsFile();
                    const reader = new FileReader();
                    reader.onload = function(event){
                        document.getElementById('preview-pago').src = event.target.result;
                        document.getElementById('preview-pago').style.display = 'block';
                    };
                    reader.readAsDataURL(blob);

                    const fileInput = document.getElementById('inp-img');
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(blob);
                    fileInput.files = dataTransfer.files;
                    Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Imagen pegada', showConfirmButton: false, timer: 2000 });
                }
            }
        }
    });

    // --- VALIDACIONES EN VIVO ---
    function dispararBurbuja(input, mensaje) {
        input.setCustomValidity(mensaje);
        input.reportValidity();
        input.oninput = function() {
            this.setCustomValidity("");
            validarFormulario();
        };
    }

    const inpDoc = document.getElementById('inp-doc');
    const inpTel = document.getElementById('inp-tel');
    const inpRef = document.getElementById('inp-ref');
    const inpMonto = document.getElementById('inp-monto');
    const btnEnviar = document.getElementById('btn-enviar-pago');

    function validarFormulario() {
        let valido = true;

        if (!/^\d+$/.test(inpDoc.value) || inpDoc.value.length < 5) valido = false;

        const regexTel = /^(0414|0412|0424|0416|0426|0212)\d{7}$/;
        if (!regexTel.test(inpTel.value)) valido = false;

        if (!/^\d{6,}$/.test(inpRef.value)) valido = false;

        if (!inpMonto.value || parseFloat(inpMonto.value) <= 0) valido = false;

        btnEnviar.disabled = !valido;
    }

    inpDoc.addEventListener('blur', function() {
        if (!/^\d+$/.test(this.value)) dispararBurbuja(this, "Solo se permiten números.");
    });

    inpTel.addEventListener('blur', function() {
        const regexTel = /^(0414|0412|0424|0416|0426|0212)\d{7}$/;
        if (!regexTel.test(this.value)) dispararBurbuja(this, "Debe tener 11 dígitos y prefijo válido (ej: 0414xxxxxxx).");
    });

    inpRef.addEventListener('blur', function() {
        if (!/^\d{6,}$/.test(this.value)) dispararBurbuja(this, "Debe tener al menos 6 dígitos numéricos.");
    });

    [inpDoc, inpTel, inpRef, inpMonto].forEach(el => el.addEventListener('keyup', validarFormulario));
    [inpMonto].forEach(el => el.addEventListener('change', validarFormulario));

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                {% if category == "success" and ("pago" in message.lower() or "reportado" in message.lower()) %}
                    Swal.fire({
                        icon: 'success',
                        title: '¡Gracias por su compra!',
                        html: 'Su pago ha sido reportado exitosamente.<br><br>Por favor, comuníquese vía WhatsApp al número <b>04143295642</b> para agilizar su entrega.',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '{{ site_config.color_principal }}'
                    });
                {% else %}
                    Swal.fire({
                        icon: '{{ "success" if category == "success" else "error" if category == "error" else "warning" }}',
                        title: '{{ message }}',
                        toast: true, position: 'top-end', showConfirmButton: false, timer: 3000
                    });
                {% endif %}
            {% endfor %}
        {% endif %}
    {% endwith %}
</script>

</body>
</html>